# 仕様分析レポート: Hilt 依存性注入セットアップ

**作成日**: 2026-01-06
**分析対象**: spec.md, plan.md, tasks.md, data-model.md, quickstart.md, research.md
**憲章バージョン**: 1.1.1

---

## 検出結果サマリー

| カテゴリ | 重大度 | 件数 |
|----------|--------|------|
| 重複検出 | 低 | 1 |
| 曖昧性検出 | 低 | 2 |
| 仕様不足 | ✅ 解決済 | 0 |
| 憲章整合性 | 合格 | - |
| カバレッジギャップ | 低 | 1 |
| 矛盾検出 | なし | 0 |

**総合評価**: ✅ 良好 - 実装開始可能

---

## A. 重複検出

### D-001: DAO提供の重複定義 (低)

**場所**:
- `data-model.md:58-68` - DatabaseModule提供物テーブル
- `quickstart.md:47-58` - 利用可能な依存関係テーブル

**説明**: DAOの一覧が両ファイルで定義されている。内容は一致しているため矛盾ではないが、更新時の同期漏れリスクがある。

**推奨対応**: 許容可能。quickstart.mdは開発者向けクイックリファレンスとして有用なため、意図的な重複として維持。

---

## B. 曖昧性検出

### A-001: エッジケースの具体的対応未定義 (低)

**場所**: `spec.md:75-79` - エッジケースセクション

**説明**: 5つのエッジケースが列挙されているが、具体的な対応方針が記載されていない。

| エッジケース | 対応方針（Hilt標準動作） |
|--------------|-------------------------|
| バインディング未定義 | コンパイル時エラー |
| 循環依存 | コンパイル時エラー |
| スコープ外アクセス | コンパイル時エラー |
| プロセス復元 | Hilt自動処理 |
| ビルドバリアント別実装 | @Qualifier使用 |

**推奨対応**: spec.mdのエッジケースセクションに対応方針を追記。ただし、すべてHiltのコンパイル時検証で対応されるため、優先度は低い。

### A-002: 「後続」ViewModelの移行時期 (低)

**場所**:
- `data-model.md:120-124` - 移行順序テーブル
- `spec.md:122` - 明確化事項

**説明**: MainModel以外のViewModel（CurrencySelectorModel, ProfileDetailModel, NewTransactionModel, TemplateDetailsViewModel）は「後続」とされているが、具体的なタイムライン・条件が未定義。

**推奨対応**: 本機能のスコープ外として許容。後続移行は別のspecification issueで扱う。

---

## C. 仕様不足検出

### U-001: MockKライブラリ依存関係 ✅ 解決済

**検出内容**: テスト例でMockKを使用しているが、`gradle/libs.versions.toml`にMockKが存在しなかった。

**対応**: tasks.mdにMockK依存関係追加タスクを挿入済み（T013, T013.1, T013.2）

---

## D. 憲章整合性チェック

| 原則 | 整合性 | 備考 |
|------|--------|------|
| I. コードの可読性とメンテナンス性 | ✅ 合格 | di/ディレクトリでの集中管理 |
| II. 単体テスト | ✅ 合格 | 本機能の主目的 |
| III. 最小構築・段階的開発 | ✅ 合格 | パイロットVM→段階移行、こまめなコミット指示あり |
| IV. パフォーマンス最適化 | ✅ 合格 | コンパイル時DI、実行時オーバーヘッド最小 |
| V. アクセシビリティ | N/A | UI変更なし |
| VI. Kotlin移行 | ✅ 合格 | すべてのDIコードはKotlin |
| VII. Nix開発環境 | ✅ 合格 | nix runコマンドでの検証指示あり |

**憲章整合性結果**: ✅ すべて合格

---

## E. カバレッジギャップ

### G-001: FR-009の検証タスク不足 (低)

**場所**: `spec.md:93` - FR-009「すべての既存アプリケーション機能は、移行後も同一に動作し続けなければならない」

**説明**: T026で「実機での動作確認」が指示されているが、具体的な検証項目が未定義。

**推奨対応**: T026の説明を拡充し、以下の検証項目を明記:
- アプリ起動確認
- プロファイル切り替え
- 取引一覧表示
- 勘定科目フィルタリング

---

## F. 矛盾検出

矛盾は検出されませんでした。

すべてのドキュメント間で以下が一貫しています:
- Hiltバージョン: 2.51.1
- KSPバージョン: 2.0.21-1.0.26（維持）
- パイロットViewModel: MainModel
- 移行戦略: 段階的（パイロット→後続）
- シングルトン戦略: ラップ（排除ではない）

---

## カバレッジサマリー

### 要件→タスク マッピング

| 要件ID | 説明 | カバレッジ | 関連タスク |
|--------|------|-----------|------------|
| FR-001 | コンストラクタインジェクション | ✅ 完全 | T019-T020 |
| FR-002 | テストダブル置換 | ✅ 完全 | T013-T017, T025 |
| FR-003 | インストルメンテーションテスト代替 | ✅ 完全 | T029-T035 |
| FR-004 | 集中化された依存関係設定 | ✅ 完全 | T008-T011 |
| FR-005 | 直接インスタンス化禁止 | ✅ 完全 | T021-T022 |
| FR-006 | DB注入可能 | ✅ 完全 | T009, T032-T033 |
| FR-007 | シングルトンスコープ維持 | ✅ 完全 | T009, T011 |
| FR-008 | Data状態アクセス可能 | ✅ 完全 | T011, T022 |
| FR-009 | 既存機能維持 | ⚠️ 部分的 | T026, T041 (検証項目未詳細) |
| FR-010 | 新規依存関係追加サポート | ✅ 完全 | T027-T028 |

### ユーザーストーリー→タスク マッピング

| ストーリー | タスク数 | カバレッジ |
|-----------|----------|-----------|
| US1 (P1) - モックでユニットテスト | 16 | ✅ 完全 |
| US2 (P2) - 依存関係管理 | 2 | ✅ 完全 |
| US3 (P3) - インストルメンテーションテスト | 7 | ✅ 完全 |
| US4 (P4) - 一貫した設定 | 3 | ✅ 完全 |

### メトリクス

| メトリクス | 値 |
|------------|-----|
| 機能要件数 | 10 |
| ユーザーストーリー数 | 4 |
| 総タスク数 | 44 (T001-T042 + T013.1, T013.2) |
| 完全カバー要件 | 9/10 (90%) |
| 部分カバー要件 | 1/10 (10%) |
| 未カバー要件 | 0/10 (0%) |

---

## 結論

仕様ドキュメントセットは**高品質**であり、実装開始に十分な状態です。

- 要件とタスクの整合性: 優秀
- 憲章との整合性: 完全準拠
- ドキュメント間の一貫性: 良好

**MockKライブラリの不足問題は解決済み**です。tasks.mdにT013, T013.1, T013.2として依存関係追加タスクを挿入しました。

**次のアクション**: `/speckit.implement`で実装を開始できます。
