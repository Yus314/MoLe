# 機能仕様書: AGP 最新安定版へのアップデート

**機能ブランチ**: `002-agp-update`
**作成日**: 2026-01-06
**ステータス**: ドラフト
**入力**: ユーザー説明: "AndroidプロジェクトのAndroid Gradle Plugin (AGP) を最新の安定版（例: 8.x）にアップデートしてください。これに伴い、Gradle Wrapperのバージョン更新や、依存ライブラリの整合性チェック、およびビルドが正常に通ることの確認も行ってください。また、実機での動作確認やテストが通ることも絶対に確認をしてください。"

## 現在の状態

プロジェクトの現在のバージョン構成:
- **Android Gradle Plugin (AGP)**: 8.0.2
- **Gradle Wrapper**: 8.0
- **Kotlin**: 1.9.25
- **compileSdk / targetSdk**: 34

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー 1 - ビルドシステムのアップグレード (優先度: P1)

開発者として、プロジェクトが最新の安定版Android Gradle Pluginを使用することで、ビルドパフォーマンスの向上、バグ修正、最新のAndroid開発機能へのアクセスを得たい。

**この優先度の理由**: AGPのアップグレードはこの機能の核心要件です。他のすべてのタスクは、正しく更新されたビルドシステムに依存しています。

**独立テスト**: アップグレード後に `nix run .#build` でプロジェクトを正常にビルドし、ビルド出力でAGPバージョンを確認することで完全にテスト可能です。

**受け入れシナリオ**:

1. **前提条件** AGP 8.0.2のプロジェクトがある場合、**操作** 開発者が最新の安定版AGPに更新すると、**結果** Gradle同期がエラーなく完了する
2. **前提条件** AGPバージョンが更新された状態で、**操作** `nix run .#build` を実行すると、**結果** デバッグAPKが正常にビルドされる
3. **前提条件** AGPバージョンが更新された状態で、**操作** `nix run .#buildRelease` を実行すると、**結果** リリースAPKが正常にビルドされる（適切な署名設定がある場合）

---

### ユーザーストーリー 2 - Gradle Wrapper の互換性 (優先度: P1)

開発者として、Gradle Wrapperのバージョンが新しいAGPに必要な最小バージョンに更新されていることで、ビルドが正しく実行されることを望む。

**この優先度の理由**: Gradle WrapperはAGPバージョンと互換性がなければなりません。互換性のないGradleバージョンはビルドの即時失敗を引き起こします。

**独立テスト**: `nix develop .#fhs` 環境内で `./gradlew --version` が正しいGradleバージョンを表示し、ビルドが正常に完了することで検証可能です。

**受け入れシナリオ**:

1. **前提条件** 新しいAGPバージョンがある場合、**操作** Gradle Wrapperバージョンを確認すると、**結果** そのAGPに必要な最小バージョン以上である
2. **前提条件** Gradle Wrapperが更新された状態で、**操作** 任意のGradleタスクを実行すると、**結果** バージョン互換性の警告やエラーが表示されない

---

### ユーザーストーリー 3 - テストスイートの検証 (優先度: P1)

開発者として、アップグレード後もすべての既存ユニットテストが成功することで、アップグレードが既存機能を破壊していないという確信を持ちたい。

**この優先度の理由**: テストはアップグレードがリグレッションを導入していないことを検証します。これはコード品質を維持するために重要です。

**独立テスト**: `nix run .#test` を実行し、すべてのテストがアップグレード前と同じ結果で成功することを確認することで検証可能です。

**受け入れシナリオ**:

1. **前提条件** アップグレードされたビルドシステムがある場合、**操作** `nix run .#test` を実行すると、**結果** すべての既存ユニットテストが成功する
2. **前提条件** アップグレードされたビルドシステムがある場合、**操作** インストルメンテーションテストを実行すると、**結果** すべての既存インストルメンテーションテストが成功する

---

### ユーザーストーリー 4 - 実機デプロイの検証 (優先度: P1)

開発者として、ビルドされたAPKが物理デバイスに正しくインストールされ実行されることで、エンドユーザーが更新されたアプリケーションを使用できることを望む。

**この優先度の理由**: 実機テストはアップグレードが成功したことの最終的な検証です。ビルド時の成功は実行時の成功を保証しません。

**独立テスト**: `nix run .#verify` を実行し、テスト、ビルド、実機インストールが完了することを確認することで検証可能です。

**受け入れシナリオ**:

1. **前提条件** 正常にビルドされたデバッグAPKがある場合、**操作** `nix run .#install` で物理Androidデバイスにインストールすると、**結果** インストールがエラーなく完了する
2. **前提条件** インストールされたアプリケーションがある場合、**操作** アプリを起動すると、**結果** アプリがクラッシュせずに正常に起動する
3. **前提条件** 実行中のアプリケーションがある場合、**操作** コア操作（アカウントの表示、取引の作成）を実行すると、**結果** すべての機能が期待通りに動作する

---

### ユーザーストーリー 5 - 依存関係の互換性 (優先度: P2)

開発者として、AGPアップグレード後もすべてのプロジェクト依存関係が互換性を維持することで、サードパーティライブラリの問題が導入されないことを望む。

**この優先度の理由**: 依存関係は新しいAGP/Gradleバージョンで動作するために更新が必要な場合がありますが、これはコアアップグレードに比べて二次的です。

**独立テスト**: Gradle同期とビルド中に依存関係解決エラーがないことを確認することで検証可能です。

**受け入れシナリオ**:

1. **前提条件** アップグレードされたビルドシステムがある場合、**操作** Gradle依存関係解決を実行すると、**結果** すべての依存関係が競合なく解決される
2. **前提条件** アップグレードされたビルドシステムがある場合、**操作** 非推奨警告を確認すると、**結果** 即時対応が必要な重大な非推奨警告がない

---

### エッジケース

- Gradleデーモンキャッシュが新しいバージョンと競合した場合どうなるか？ `nix run .#clean` を使用してキャッシュをクリアし、必要に応じて `.gradle` ディレクトリを削除する。
- 新しいAGPでKotlin/Java混合コンパイルはどのように処理されるか？ KotlinとJavaの両方のソースファイルが正しくコンパイルされることを検証する。
- Roomアノテーション処理が失敗した場合どうなるか？ kapt設定が新しいAGPと互換性があることを検証する。

## 要件 *(必須)*

### 機能要件

- **FR-001**: ビルドシステムは **AGP 8.7.3** を使用しなければならない
- **FR-002**: Gradle Wrapperは **Gradle 8.9** に更新されなければならない
- **FR-003**: プロジェクトはデバッグとリリースの両方の構成で正常にビルドできなければならない
- **FR-004**: すべての既存ユニットテストは変更なしで成功しなければならない
- **FR-005**: すべての既存インストルメンテーションテストは変更なしで成功しなければならない
- **FR-006**: ビルドされたAPKは物理Androidデバイスに正しくインストールされ実行されなければならない
- **FR-007**: バージョンカタログ（libs.versions.toml）は新しいバージョン番号で更新されなければならない
- **FR-008**: ビルドはアノテーション処理（Room、kapt）に関連するエラーなく完了しなければならない
- **FR-009**: プロジェクトは既存コードとの後方互換性を維持しなければならない（ビルド設定以外のソース変更は不要）

### 主要エンティティ

- **ビルド設定**: プロジェクトのビルドシステムを定義するGradleビルドファイル（build.gradle、gradle-wrapper.properties、libs.versions.toml）
- **依存関係**: アップグレードされたビルドシステムとの互換性を持つサードパーティライブラリ

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: `nix run .#build` が正常に完了する
- **SC-002**: `nix run .#buildRelease` が正常に完了する
- **SC-003**: `nix run .#test` が既存テストの100%成功で完了する
- **SC-004**: ビルドされたAPKがインストールエラーなく物理デバイスにインストールされる（`nix run .#install`）
- **SC-005**: アプリケーションが物理デバイスでクラッシュなく起動し実行される
- **SC-006**: ビルド出力に差し迫った破壊を示す重大な非推奨警告がない
- **SC-007**: ビルド時間がアップグレード前のベースラインと比較して50%以上増加しない

## Clarifications

### Session 2026-01-06

- Q: ターゲットAGPバージョンの選択 → A: AGP 8.7.3（8.7.xシリーズの最新パッチ）
- Q: Gradle Wrapperのターゲットバージョン → A: Gradle 8.9（AGP 8.7.3の最小要件）

## 前提条件

- ターゲットAGPバージョンは **AGP 8.7.3**（8.7.xシリーズの最新パッチリリース）
- 物理デバイステストはAPIレベル22以上のAndroidデバイスで実行される（minSdkVersionに一致）
- リリースビルドの署名設定が適切に構成されている（keystore.propertiesがリリース署名用に存在）
- 現在のKotlinバージョン（1.9.25）はAGP互換性で更新が必要でない限り変更されない
- Nix Flakeコマンドを使用してビルド、テスト、インストールを行う
