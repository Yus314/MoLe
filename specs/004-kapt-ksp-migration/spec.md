# 機能仕様書: KAPT から KSP への移行

**機能ブランチ**: `004-kapt-ksp-migration`
**作成日**: 2026-01-06
**ステータス**: ドラフト
**入力**: ユーザー説明: "ビルド設定を KAPT から KSP (Kotlin Symbol Processing) に移行する"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 開発者が KSP でプロジェクトをビルドする (優先度: P1)

開発者がリポジトリをクローンしてビルドを実行する。プロジェクトは KAPT ではなく KSP を使用してアノテーション処理を行い、アプリケーションコードの変更なしに正常にコンパイルされる。

**この優先度の理由**: これは核心的な成果物であり、移行が完了したとみなすためにはビルドが KSP で動作する必要がある。

**独立テスト**: `nix run .#build` を実行し、APK が正常に生成されることで完全にテスト可能。より高速なインクリメンタルビルドを実現。

**受け入れシナリオ**:

1. **前提** リポジトリのクリーンチェックアウト、**操作** 開発者が `nix run .#build` を実行、**結果** KAPT 関連のエラーなしにプロジェクトが正常にコンパイルされる
2. **前提** KSP が設定されている、**操作** ビルドが完了、**結果** Room データベーススキーマファイルが `$projectDir/schemas` に生成される
3. **前提** プロジェクトが Room アノテーションを使用、**操作** KSP がアノテーションを処理、**結果** すべての DAO 実装が正しく生成される

---

### ユーザーストーリー 2 - 開発者がより高速なインクリメンタルビルドを体験する (優先度: P2)

開発者が Kotlin ソースコードを変更して再ビルドする。KSP のより良いインクリメンタル処理サポートにより、インクリメンタルビルドが KAPT より高速に完了する。

**この優先度の理由**: パフォーマンス改善は移行の主要な利点だが、まずビルドが動作する必要がある。

**独立テスト**: 同じハードウェアで移行前後のインクリメンタルビルド時間を計測してテスト可能。

**受け入れシナリオ**:

1. **前提** プロジェクトが一度ビルドされている、**操作** 開発者が Kotlin ファイルを変更して再ビルド、**結果** KSP は影響を受けたファイルのみを再処理
2. **前提** KSP が `room.incremental=true` で設定されている、**操作** アノテーション処理が実行、**結果** 変更されていないファイルは再処理されない

---

### ユーザーストーリー 3 - 開発者がユニットテストを正常に実行する (優先度: P1)

開発者がユニットテストスイートを実行する。生成されたコードが機能的に同等であることを示すため、既存のすべてのテストが変更なしに合格する。

**この優先度の理由**: テストは移行が既存の機能を壊していないことを検証する。

**独立テスト**: `nix run .#test` を実行し、すべてのテストが合格することで完全にテスト可能。

**受け入れシナリオ**:

1. **前提** KSP が設定されている、**操作** 開発者が `nix run .#test` を実行、**結果** すべてのユニットテストが合格
2. **前提** Room DAO が KSP により生成されている、**操作** データベーステストが実行、**結果** すべてのデータベース操作が正しく動作

---

### エッジケース

- KSP プラグインがキャッシュされていないマシンでビルドした場合は？ビルドは自動的にプラグインをダウンロードしてキャッシュする。
- Java/Kotlin 混合ソースをビルドがどのように処理するか？KSP は Kotlin アノテーションを処理し、既存の Java アノテーションプロセッサは影響を受けない。
- スキーマ出力ディレクトリが存在しない場合は？ビルドは自動的に作成する（既存の動作を維持）。

## 要件 *(必須)*

### 機能要件

- **FR-001**: ビルドシステムは Room アノテーション処理に KAPT ではなく KSP を使用しなければならない
- **FR-002**: ビルドシステムは Room データベーススキーマファイルを `$projectDir/schemas` に生成しなければならない
- **FR-003**: ビルドシステムは `room.incremental=true` によるインクリメンタルアノテーション処理をサポートしなければならない
- **FR-004**: ビルドシステムは Java 8 互換性を維持しなければならない (JVM target 1.8)
- **FR-005**: ビルドシステムはデバッグおよびリリース APK を正常に生成しなければならない
- **FR-006**: 既存のすべてのユニットテストは変更なしに合格しなければならない
- **FR-007**: バージョンカタログは Kotlin 2.0.21 と互換性のある KSP プラグインバージョンを定義しなければならない

### 主要エンティティ

- **バージョンカタログ (libs.versions.toml)**: 依存関係バージョンの中央管理場所。KSP バージョンとプラグイン定義を追加する必要がある
- **ルート build.gradle**: トップレベルのビルド設定。KAPT プラグインを KSP プラグインに置き換える必要がある
- **App build.gradle**: モジュールビルド設定。`ksp()` 依存関係設定と KSP 引数ブロックを使用する必要がある
- **Room Compiler**: データベースコード生成用アノテーションプロセッサ。同じアーティファクトが KAPT と KSP の両方で動作する

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: クリーンビルド (`nix run .#build`) が KAPT 関連の警告やエラーなしに正常に完了する
- **SC-002**: すべてのユニットテスト (`nix run .#test`) が 100% の成功率で合格する
- **SC-003**: 完全な検証ワークフロー (`nix run .#verify`) がデバイスへのインストールを含めて正常に完了する
- **SC-004**: すべてのビルドファイルに `kapt` 設定が残っていない（部分的ではなく完全な移行）
- **SC-005**: Room スキーマファイルが正しい形式で `app/schemas/` ディレクトリに生成される

## 前提条件

- Kotlin バージョン 2.0.21 は KSP バージョン 2.0.21-1.0.26（Kotlin 2.0.x 向け安定版）と互換性がある
- Room 2.4.2 は KSP をサポートしている（Room はバージョン 2.4.0 から KSP をサポート）
- Room 以外のアノテーションプロセッサは移行不要（確認済み：このプロジェクトで KAPT を使用しているのは Room のみ）
- `room.expandProjection` 引数は KSP 設定でサポートされている
- Java/Kotlin 混合コードベースは特別な KSP 設定を必要としない

## 技術分析サマリー

**現在の設定 (KAPT)**:
- ルート `build.gradle`: `alias(libs.plugins.kotlin.kapt) apply false`
- App `build.gradle`: `alias(libs.plugins.kotlin.kapt)` 適用済み、`kapt libs.androidx.room.compiler`
- KAPT 引数は `kapt {}` ブロックと `javaCompileOptions.annotationProcessorOptions` に定義

**目標設定 (KSP)**:
- バージョンカタログ: `ksp = "2.0.21-1.0.26"` バージョンと `ksp` プラグイン定義を追加
- ルート `build.gradle`: KAPT プラグインを KSP プラグインに置き換え
- App `build.gradle`: KSP プラグインを適用、`kapt()` を `ksp()` に置き換え、Room 引数を `ksp {}` ブロックに移行

**移行対象ライブラリ**:
1. Room Compiler (`androidx.room:room-compiler:2.4.2`) - KAPT を使用している唯一のライブラリ
