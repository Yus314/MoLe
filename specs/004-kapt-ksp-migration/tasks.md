# タスク: KAPT から KSP への移行

**入力**: `/specs/004-kapt-ksp-migration/` のデザインドキュメント
**前提条件**: plan.md (必須), spec.md (必須), research.md

**テスト**: 既存のユニットテストで検証（新規テスト不要）

**構成**: ユーザーストーリーごとにタスクをグループ化し、独立した実装とテストを可能にする

## フォーマット: `[ID] [P?] [Story] 説明`

- **[P]**: 並列実行可能（異なるファイル、依存関係なし）
- **[Story]**: このタスクが属するユーザーストーリー（例: US1, US2, US3）
- 説明には正確なファイルパスを含める

## パス規約

- **Android プロジェクト**: `gradle/`, `app/`, ルートの `build.gradle`
- plan.md の構造に基づく

---

## Phase 1: セットアップ

**目的**: バージョンカタログの更新

- [x] T001 KSP バージョンを `gradle/libs.versions.toml` の `[versions]` セクションに追加（`ksp = "2.0.21-1.0.26"`）
- [x] T002 KSP プラグインを `gradle/libs.versions.toml` の `[plugins]` セクションに追加
- [x] T003 KAPT プラグイン定義を `gradle/libs.versions.toml` から削除

**チェックポイント**: バージョンカタログに KSP が定義され、KAPT が削除されている

---

## Phase 2: 基盤（ブロッキング前提条件）

**目的**: ルートビルドファイルのプラグイン更新

**⚠️ 重要**: このフェーズが完了するまで、アプリモジュールの変更は開始できない

- [x] T004 ルート `build.gradle` の KAPT プラグインを KSP プラグインに置き換え

**チェックポイント**: ルートビルドファイルが KSP を宣言、Gradle 同期が成功

---

## Phase 3: ユーザーストーリー 1 - 開発者が KSP でプロジェクトをビルドする (優先度: P1) 🎯 MVP

**ゴール**: プロジェクトが KAPT ではなく KSP を使用して正常にコンパイルされる

**独立テスト**: `nix run .#build` を実行し、APK が正常に生成されることを確認

### ユーザーストーリー 1 の実装

- [x] T005 [US1] `app/build.gradle` のプラグインセクションで KAPT を KSP に置き換え
- [x] T006 [US1] `app/build.gradle` から `javaCompileOptions.annotationProcessorOptions` ブロックを削除
- [x] T007 [US1] `app/build.gradle` から `kapt {}` ブロックを削除
- [x] T008 [US1] `app/build.gradle` に `ksp {}` ブロックを追加（Room 引数を設定）
- [x] T009 [US1] `app/build.gradle` の dependencies セクションで `kapt` を `ksp` に変更
- [x] T010 [US1] `app/build.gradle` から KAPT 関連のコメントを削除
- [x] T011 [US1] ビルド検証: `nix run .#build` を実行

**チェックポイント**: ビルドが成功し、APK が生成される

---

## Phase 4: ユーザーストーリー 2 - 開発者がより高速なインクリメンタルビルドを体験する (優先度: P2)

**ゴール**: KSP のインクリメンタル処理が有効になっている

**独立テスト**: `ksp {}` ブロックに `room.incremental=true` が設定されていることを確認

### ユーザーストーリー 2 の実装

- [x] T012 [US2] `ksp {}` ブロックに `room.incremental` 引数が設定されていることを確認

**チェックポイント**: インクリメンタルビルドが有効（T008 で既に設定済み、確認のみ）

---

## Phase 5: ユーザーストーリー 3 - 開発者がユニットテストを正常に実行する (優先度: P1)

**ゴール**: 既存のすべてのユニットテストが KSP で生成されたコードで合格する

**独立テスト**: `nix run .#test` を実行し、すべてのテストが合格することを確認

### ユーザーストーリー 3 の実装

- [x] T013 [US3] テスト検証: `nix run .#test` を実行

**チェックポイント**: すべてのユニットテストが合格

---

## Phase 6: 完了と検証

**目的**: 最終検証と完全性確認

- [x] T014 Room スキーマファイルが `app/schemas/` に生成されていることを確認
- [x] T015 ビルドログに KAPT 関連のエラー・警告がないことを確認
- [x] T016 フル検証: `nix run .#verify` を実行（テスト → ビルド → インストール）
- [x] T017 すべてのビルドファイルに `kapt` 設定が残っていないことを確認

---

## 依存関係と実行順序

### フェーズ依存関係

- **セットアップ (Phase 1)**: 依存関係なし - すぐに開始可能
- **基盤 (Phase 2)**: セットアップ完了に依存 - すべてのユーザーストーリーをブロック
- **ユーザーストーリー (Phase 3-5)**: 基盤フェーズ完了に依存
  - US1 → US2 → US3 の順序で実行（ビルドが先、テストが後）
- **完了 (Phase 6)**: すべてのユーザーストーリー完了に依存

### ユーザーストーリー依存関係

- **ユーザーストーリー 1 (P1)**: 基盤 (Phase 2) 完了後に開始可能
- **ユーザーストーリー 2 (P2)**: US1 に依存（`ksp {}` ブロックは US1 で作成）
- **ユーザーストーリー 3 (P1)**: US1 に依存（ビルドが成功している必要がある）

### 並列実行の機会

この移行は単一ファイルへの連続的な変更が多いため、並列実行の機会は限定的：

- T001, T002, T003 は同一ファイルのため並列不可
- ただし、Phase 6 の検証タスク（T014-T017）は概念的に並列実行可能

---

## 並列実行例: Phase 6

```bash
# Phase 6 の検証タスクは並列で実行可能:
Task: "Room スキーマファイルが app/schemas/ に生成されていることを確認"
Task: "ビルドログに KAPT 関連のエラー・警告がないことを確認"
```

---

## 実装戦略

### MVP ファースト（ユーザーストーリー 1 のみ）

1. Phase 1 完了: セットアップ
2. Phase 2 完了: 基盤
3. Phase 3 完了: ユーザーストーリー 1
4. **停止して検証**: `nix run .#build` でビルド成功を確認
5. 問題なければ続行

### インクリメンタルデリバリー

1. セットアップ + 基盤 → 基盤完了
2. ユーザーストーリー 1 → ビルド成功 (MVP!)
3. ユーザーストーリー 2 → インクリメンタル設定確認
4. ユーザーストーリー 3 → テスト成功
5. Phase 6 → 完全な検証

---

## ノート

- この移行は 3 つのビルドファイルのみを変更
- 既存のアプリケーションコードに変更は不要
- 既存のユニットテストで回帰を検出可能
- コミットは論理的な区切りごとに実行（例: Phase 1 完了後、Phase 2 完了後など）
- 問題が発生した場合は [research.md](./research.md) と [quickstart.md](./quickstart.md) を参照
