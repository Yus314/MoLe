# Feature Specification: Jetpack Compose UI Rebuild

**Feature Branch**: `006-compose-ui-rebuild`
**Created**: 2026-01-06
**Status**: Completed
**Input**: User description: "Jetpack Composeを使用して既存のUIの再構築を行う"

## Clarifications

### Session 2026-01-06

- Q: 既存XMLコードの扱い（削除タイミング） → A: 各Phase完了・検証後に該当画面のXMLを削除
- Q: アクセシビリティ対応レベル → A: 現行実装と同等のアクセシビリティを維持（変更なし）

## 目的

1. コードの可読性と一貫性を向上させる
2. 再利用性の高いコンポーネント設計をする
3. 宣言的なUIによる状態管理の改善

## 画面移行優先順位の考察

### 現在のUI構成

| 画面 | 複雑度 | 主要コンポーネント | 移行難易度 |
|------|--------|-------------------|------------|
| **MainActivity** | 高 | ViewPager2、NavigationDrawer、FAB、複数Fragment | 高 |
| **NewTransactionActivity** | 高 | 動的フォーム、複数行入力、テンプレート適用 | 高 |
| **TemplatesActivity** | 中 | RecyclerView、Navigation Component | 中 |
| **ProfileDetailActivity** | 中 | フォーム入力、カスタムHueRing | 中 |
| **BackupsActivity** | 低 | シンプルなリスト表示 | 低 |
| **SplashActivity** | 低 | 初期化のみ | 低 |

### 推奨移行順序

**Phase 1: 基盤構築（推奨開始点）**
- **ProfileDetailActivity** を最初の移行対象として推奨
- 理由：
  - 独立した画面で他の画面への影響が少ない
  - フォーム入力パターンを確立できる
  - カスタムViewの移行（HueRing）を試験できる
  - Material 3テーマの基盤を構築できる

**Phase 2: リスト画面**
- TemplatesActivity
- 理由：Navigation Component使用のため移行パターンを確立しやすい

**Phase 3: コア画面**
- MainActivity（AccountSummaryFragment、TransactionListFragment含む）
- 理由：最も使用頻度が高い画面だが、ViewPager2の移行が複雑

**Phase 4: 複雑なフォーム**
- NewTransactionActivity
- 理由：動的フォームの複雑さから最後に移行

## User Scenarios & Testing *(mandatory)*

### User Story 1 - プロファイル設定画面の操作 (Priority: P1)

ユーザーは、hledger-webサーバーへの接続設定を行うプロファイル設定画面を使用する。新しいJetpack Compose実装でも、現行のXML実装と全く同じ操作体験を得られる必要がある。

**Why this priority**: プロファイル設定は他の全機能の前提条件であり、最初に安定させるべき画面。また、独立した画面のため他への影響なく移行検証ができる。

**Independent Test**: プロファイルの新規作成・編集・削除が正常に動作し、サーバー接続テストが成功すること。

**Acceptance Scenarios**:

1. **Given** プロファイル設定画面を開いた状態, **When** 必須項目（名前、URL）を入力して保存ボタンをタップ, **Then** プロファイルが保存され、メイン画面に戻る
2. **Given** 既存のプロファイルを編集中, **When** テーマカラー（Hue）を変更, **Then** 画面のテーマカラーがリアルタイムでプレビュー更新される
3. **Given** プロファイル設定画面を開いた状態, **When** サーバーURLを入力して接続テストボタンをタップ, **Then** 接続成功/失敗のフィードバックが表示される
4. **Given** 未保存の変更がある状態, **When** 戻るボタンをタップ, **Then** 変更破棄の確認ダイアログが表示される

---

### User Story 2 - テンプレート管理画面の操作 (Priority: P2)

ユーザーは、頻繁に使用する取引パターンをテンプレートとして保存・管理する。テンプレート一覧の表示、新規作成、編集、削除の全ての操作が現行実装と同一の挙動を示す。

**Why this priority**: テンプレート機能は取引入力の効率化に重要だが、プロファイル設定より優先度は低い。リスト画面のComposeパターンを確立する良い対象。

**Independent Test**: テンプレートの一覧表示、作成、編集、削除が正常に動作すること。

**Acceptance Scenarios**:

1. **Given** テンプレート一覧画面を開いた状態, **When** 既存テンプレートが存在する, **Then** テンプレート名と説明がリスト表示される
2. **Given** テンプレート一覧画面を開いた状態, **When** FABをタップ, **Then** 新規テンプレート作成画面に遷移する（スライドアニメーション付き）
3. **Given** テンプレート詳細画面でテンプレートを編集中, **When** 保存ボタンをタップ, **Then** テンプレートが保存され、一覧画面に戻る
4. **Given** テンプレート一覧画面でテンプレートを長押し, **When** 削除オプションを選択, **Then** 削除確認ダイアログが表示され、確認後に削除される

---

### User Story 3 - メイン画面の操作 (Priority: P3)

ユーザーは、アプリ起動時にメイン画面を使用してアカウント残高の確認と取引履歴の閲覧を行う。タブ切り替え、ナビゲーションドロワー、プルリフレッシュ等の全ての操作が現行実装と同一の挙動を示す。

**Why this priority**: 最も使用頻度が高い画面だが、ViewPager2の移行が複雑なため、他の画面で移行パターンを確立してから着手する。

**Independent Test**: アカウント一覧・取引一覧のタブ切り替え、ドロワーからのプロファイル切り替え、データ更新が正常に動作すること。

**Acceptance Scenarios**:

1. **Given** メイン画面を開いた状態, **When** アカウント一覧タブと取引一覧タブを切り替え, **Then** スワイプまたはタブタップでスムーズに切り替わる
2. **Given** メイン画面を開いた状態, **When** ナビゲーションドロワーを開いてプロファイルを切り替え, **Then** 選択したプロファイルのデータが表示される
3. **Given** アカウント一覧を表示中, **When** プルリフレッシュを実行, **Then** サーバーからデータを再取得し、ローディングインジケータが表示される
4. **Given** メイン画面でFABをタップ, **When** 遷移アニメーションが完了, **Then** 取引登録画面が表示される

---

### User Story 4 - 取引登録画面の操作 (Priority: P4)

ユーザーは、新規取引を登録する際に取引登録画面を使用する。日付選択、説明入力、複数のアカウント行追加、金額入力、テンプレート適用等の全ての操作が現行実装と同一の挙動を示す。

**Why this priority**: 最も複雑なフォーム画面であり、動的な行追加・削除が必要。他の全ての画面の移行パターンを確立してから着手する。

**Independent Test**: 取引の日付・説明・複数アカウント行を入力して保存が成功すること。

**Acceptance Scenarios**:

1. **Given** 取引登録画面を開いた状態, **When** 日付フィールドをタップ, **Then** DatePickerダイアログが表示され、日付選択後にフィールドに反映される
2. **Given** 取引登録画面でアカウント行を入力中, **When** アカウント名を入力, **Then** オートコンプリート候補が表示され、選択できる
3. **Given** 取引登録画面を開いた状態, **When** 行追加ボタンをタップ, **Then** 新しいアカウント行が追加される（アニメーション付き）
4. **Given** 全ての必須項目を入力した状態, **When** 保存ボタンをタップ, **Then** 取引が保存され、保存中のプログレス表示後にメイン画面に戻る
5. **Given** テンプレートボタンをタップ, **When** テンプレートを選択, **Then** テンプレートの内容がフォームに反映される

---

### Edge Cases

- プロファイルが存在しない場合、メイン画面ではウェルカムメッセージを表示する
- ネットワークエラー時、適切なエラーメッセージをSnackbarで表示する
- 大量のアカウント/取引がある場合でも、スクロールがスムーズに動作する
- 画面回転時、入力中のデータが保持される
- キーボード表示時、入力フィールドが適切にスクロールされる
- ダークモード/ライトモードの切り替えに正しく対応する

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、現行のXML実装と同一のUI外観をJetpack Composeで再現する
- **FR-002**: システムは、現行実装の全てのタップ・スワイプ・長押しジェスチャーを同一の挙動で再現する
- **FR-003**: システムは、現行実装の全ての画面遷移アニメーションを同一のタイミングで再現する
- **FR-004**: システムは、現行実装の全てのエラー表示（Snackbar、ダイアログ）を同一の形式で再現する
- **FR-005**: システムは、HueRingカスタムViewをJetpack Compose Canvasで同一の外観・操作性で再現する
- **FR-006**: システムは、現行のHilt依存性注入パターンをJetpack Compose画面でも使用する
- **FR-007**: システムは、現行のRoomデータベースとDAO層をそのまま使用する
- **FR-008**: システムは、現行のLiveDataをStateFlow/Flowに段階的に移行する
- **FR-009**: システムは、Material 3デザインシステムを採用しつつ、現行の外観を維持する
- **FR-010**: システムは、プロファイルごとのHSLベーステーマカラーをCompose Themeで再現する
- **FR-011**: システムは、現行のNavigation Componentの遷移を Compose Navigationで置き換える
- **FR-012**: システムは、RecyclerViewをLazyColumn/LazyRowで置き換え、同等のパフォーマンスを維持する
- **FR-013**: システムは、段階的な移行を可能にするため、ComposeとXML実装の共存をサポートする
- **FR-014**: システムは、既存の自動テストが修正なしで通過するようにする

### Key Entities

- **Profile**: サーバー接続設定、テーマカラー、同期状態を持つエンティティ（既存のRoomエンティティを継続使用）
- **Transaction**: 取引日付、説明、複数のアカウント行を持つエンティティ（既存のRoomエンティティを継続使用）
- **Template**: 繰り返し使用される取引パターンを保存するエンティティ（既存のRoomエンティティを継続使用）
- **Account**: アカウント名、残高、通貨を持つエンティティ（既存のRoomエンティティを継続使用）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 移行後の画面は、現行実装と並べて比較した際にユーザーが違いを区別できないレベルの外観一致度を達成する
- **SC-002**: 全ての画面遷移アニメーションのタイミングが現行実装と同等（±50ms以内）である
- **SC-003**: リスト画面（アカウント一覧、取引一覧、テンプレート一覧）で1000件以上のデータをスムーズにスクロールできる（60fps維持）
- **SC-004**: 既存の全てのユニットテストが修正なしで通過する
- **SC-005**: 既存の全てのインストルメンテーションテストが修正なしで通過する
- **SC-006**: 各Phase完了後、実機での手動検証で全ての操作が正常に動作することを確認できる
- **SC-007**: APKサイズの増加が10%以内に収まる
- **SC-008**: アプリの起動時間が現行実装と同等（±200ms以内）である

## Assumptions

- Android minSdk 26以上を対象とする（Compose BOMの要件）
- Material 3の採用により、一部のコンポーネント外観が微妙に変わる可能性があるが、ユーザー体験に影響しない範囲とする
- 段階的移行中は、ComposeとXMLの画面が共存する過渡期がある
- 既存のRoom/Hilt/Coroutines基盤はそのまま活用する
- 各Phase完了・検証後に、該当画面の既存XMLレイアウトファイルとFragmentクラスを削除する（技術的負債の段階的解消）

## Out of Scope

- 新機能の追加（UIの再構築のみ）
- バックエンドAPIの変更
- データベーススキーマの変更
- アプリアーキテクチャの大規模な変更（MVVMパターンは維持）
- アクセシビリティの強化（現行実装と同等レベルを維持）
