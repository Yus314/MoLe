# 機能仕様書: TransactionAccumulator テスト可能性向上

**機能ブランチ**: `012-accumulator-testability`
**作成日**: 2026-01-14
**ステータス**: ドラフト
**入力**: ユーザー説明: "TransactionAccumulator のテスト可能性向上"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 開発者が TransactionAccumulator のユニットテストを作成する (優先度: P1)

開発者として、TransactionAccumulator クラスの自動ユニットテストを作成し、様々な通貨シナリオで累計残高計算ロジックが正しく動作することを検証したい。

**この優先度の理由**: これが機能の核心目標 - ユニットテストを可能にすること。この能力がなければ、TransactionAccumulator コンポーネントは品質リスクとアーキテクチャの不整合のままである。

**独立テスト**: フェイク通貨フォーマッターを使用する新しいテストファイルを作成し、`nix run .#test` を実行してすべてのテストがパスすることを確認することで完全にテスト可能。

**受け入れシナリオ**:

1. **前提** 注入されたフェイク通貨フォーマッターを持つ TransactionAccumulator、**操作** 開発者が金額を含む取引を追加する、**結果** 累計はグローバルインスタンスではなく注入されたフォーマッターを使用してフォーマットされる。

2. **前提** 完全なアプリケーションコンテキストのないテスト環境、**操作** 開発者がフェイクフォーマッターで TransactionAccumulator をインスタンス化する、**結果** Application 起動を必要とせずにインスタンス化が成功する。

3. **前提** 日本円フォーマット用に設定されたフェイク通貨フォーマッター、**操作** 取引が累積される、**結果** 累計出力が設定されたフォーマットを反映する。

---

### ユーザーストーリー 2 - 開発者がデバイスやエミュレーターなしでテストを実行する (優先度: P2)

開発者として、TransactionAccumulator のテストを Android デバイスやエミュレーターを必要としない高速なローカル JVM テストとして実行し、開発中の迅速なフィードバックを得たい。

**この優先度の理由**: 高速なフィードバックループは開発者の生産性に不可欠。JVM テストは計装テストの数分に対して数秒で実行される。

**独立テスト**: `nix run .#test` を実行し、TransactionAccumulator テストが（androidTest ではなく）ユニットテストスイートで実行されることを確認することでテスト可能。

**受け入れシナリオ**:

1. **前提** `app/src/test/` ディレクトリにある TransactionAccumulator テスト、**操作** 開発者が `./gradlew test` を実行する、**結果** Android 依存関係を必要とせずにテストが完了する。

---

### ユーザーストーリー 3 - 既存のアプリケーション動作が変更されない (優先度: P1)

ユーザーがアプリで取引一覧を表示するとき、累計残高表示と通貨フォーマットはこの変更前と完全に同じように動作する必要がある。

**この優先度の理由**: P1 と同等 - ユーザー向け動作のいかなるリグレッションも許容されない。これは機能変更ゼロの純粋なリファクタリングタスク。

**独立テスト**: アプリをデバイスにインストールし、取引一覧に移動し、通貨表示が現在の動作と一致することを確認することでテスト可能。

**受け入れシナリオ**:

1. **前提** 複数通貨を含む取引、**操作** ユーザーがアカウントフィルタリングで取引一覧を表示する、**結果** 累計残高が変更前と同じフォーマットで表示される。

2. **前提** デバイスで実行中のアプリケーション、**操作** ユーザーがアカウントフィルタを適用する、**結果** 累計が現在の動作と同一に計算・表示される。

---

### エッジケース

- フォーマッターが null の場合はどうなるか？ TransactionAccumulator コンストラクタは非 null の CurrencyFormatter を要求する必要がある - これは Kotlin の型システムによりコンパイル時に強制される。
- TransactionAccumulator がインスタンス化された後にロケールが変更された場合はどう処理するか？ フォーマッターはフォーマット時に現在のロケール設定を使用するため、ロケール変更は正しく処理される。
- 注入されたフォーマッターが例外をスローした場合はどうなるか？ 標準の例外伝播が適用される - 特別な処理は不要。

## 要件 *(必須)*

### 機能要件

- **FR-001**: TransactionAccumulator はコンストラクタを通じて CurrencyFormatter 依存関係を受け入れなければならない（MUST）。
- **FR-002**: TransactionAccumulator はグローバル状態（App.currencyFormatter()）に直接アクセスしてはならない（MUST NOT）。
- **FR-003**: すべての既存呼び出し箇所は CurrencyFormatter 依存関係を渡すように更新されなければならない（MUST）。
- **FR-004**: 本番 CurrencyFormatter 実装を使用する場合、通貨フォーマット出力は現在の動作と同一でなければならない（MUST）。
- **FR-005**: テストコードは Application コンテキストなしで FakeCurrencyFormatter を使用して TransactionAccumulator をインスタンス化できなければならない（MUST）。
- **FR-006**: 新しいユニットテストは単一および複数通貨シナリオの累計残高計算ロジックを検証しなければならない（MUST）。

### 主要エンティティ

- **TransactionAccumulator**: 取引リストの累計を計算し、累計残高をフォーマットする。コンストラクタインジェクションを通じて CurrencyFormatter を受け取る。
- **CurrencyFormatter**: ロケール対応の数値/通貨フォーマットのインターフェース。本番実装（CurrencyFormatterImpl）とテスト実装（FakeCurrencyFormatter）が既に存在する。
- **TransactionListItem**: フォーマットされた累計を受け取る表示モデル。変更不要。

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: TransactionAccumulator に Android 依存関係なしで実行される新しいユニットテストファイルが少なくとも 1 つ存在する。
- **SC-002**: すべての既存ユニットテストが引き続きパスする（`nix run .#test` が成功）。
- **SC-003**: アプリケーションが正常にビルドされる（`nix run .#build` が成功）。
- **SC-004**: 静的解析がパスする（`nix run .#lint` が新しいエラーを生成しない）。
- **SC-005**: 実機での取引一覧の通貨表示が変更前後で視覚的に同一である。
- **SC-006**: TransactionAccumulator ソースファイルに `App.currencyFormatter()` への参照が含まれていない。

## 前提条件

- 既存の `CurrencyFormatter` インターフェースと `FakeCurrencyFormatter` 実装がテストニーズに十分である。
- 既存の Hilt 依存性注入セットアップにより、`TransactionAccumulator` をインスタンス化する ViewModel に `CurrencyFormatter` を提供できる。
- テストインフラ（MainDispatcherRule、TestUtils）は以前のテストカバレッジ作業（011-test-coverage）から既に整備されている。
- `CurrencyFormatter` は既にシングルトンとして提供されているため、Hilt DI モジュールへの変更は不要。

## スコープ外

- グローバル状態に依存する他のコンポーネントのリファクタリング。
- CurrencyFormatter インターフェースまたは実装の変更。
- TransactionAccumulator のパフォーマンス最適化。
- すべてのエッジケースの包括的なテストカバレッジの追加（テスト可能性の実現に焦点を当て、網羅的なテストではない）。
- 取引データモデルまたはストレージの変更。
